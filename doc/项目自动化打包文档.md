# é¡¹ç›®è‡ªåŠ¨åŒ–æ‰“åŒ…é…ç½®

Author: wangk

Summaryï¼š

åœºæ™¯æè¿°ï¼š

â€‹			å¼€å‘äººå‘˜ä»£ç åˆå¹¶åˆ°devåˆ†æ”¯åï¼Œ

â€‹			åŒæ—¶ä¿®æ”¹äº†pom æ–‡ä»¶çš„ç‰¹æ®Šç‰ˆæœ¬æ ‡è®°ï¼Œ

â€‹			ä¼šè§¦å‘ jenkins è‡ªåŠ¨æ‰“åŒ…æˆdockeré•œåƒã€‚



é…ç½®æ­¥éª¤

 1. é…ç½® pom.xml æ–‡ä»¶

    - JunFengDockerImageName  è¡¨ç¤ºæ‰“åŒ…é•œåƒçš„åç§°ï¼Œç”±å¼€å‘å›¢é˜Ÿçº¦å®šï¼
    - JunFengDockerImageVersion è¡¨ç¤ºæ‰“åŒ…é•œåƒçš„ç‰ˆæœ¬ï¼Œç”±å¼€å‘å›¢é˜Ÿçº¦å®šï¼

    åœ¨pom.xml æ–‡ä»¶ä¸­ç²˜è´´ä¸‹æ–‡ï¼š

    ```xml
    	<!-- do not modify this docker build config, unless you know it! -->
    	<!-- === docker build copy BEGIN === -->
    	<properties>
    		<JunFengDockerImageName>${è¯·æŒ‰çº¦å®šä¿®æ”¹æ­¤å¤„ï¼jf-member-center}</JunFengDockerImageName>
    		<JunFengDockerImageVersion>${è¯·æŒ‰çº¦å®šä¿®æ”¹æ­¤å¤„ï¼0.01.123}</JunFengDockerImageVersion>
    	</properties>
    	<build>
    		<plugins>
    			<plugin>
    				<groupId>org.springframework.boot</groupId>
    				<artifactId>spring-boot-maven-plugin</artifactId>
    			</plugin>
    			<!-- dockerçš„mavenæ’ä»¶ï¼Œå®˜ç½‘ https://github.com/spotify/docker-maven-plugin -->
    			<plugin>
    				<groupId>com.spotify</groupId>
    				<artifactId>docker-maven-plugin</artifactId>
    				<version>1.0.0</version>
    				<configuration>
    					<imageName>
    						192.168.199.12:50000/${JunFengDockerImageName}:${JunFengDockerImageVersion}
    					</imageName>
    					<baseImage>jre1.8:0.0.1</baseImage>
    					<workdir>/${project.build.finalName}</workdir>
    					<entryPoint>
    						["java", "-Djava.security.egd=file:/dev/./urandom", "-jar","/${project.build.finalName}/${project.build.finalName}.jar"]
    					</entryPoint>
    					<resources>
    						<resource>
    							<targetPath>/${project.build.finalName}</targetPath>
    							<directory>${project.build.directory}</directory>
    							<include>${project.build.finalName}.jar</include>
    						</resource>
    					</resources>
    					<dockerHost>http://192.168.199.12:2375</dockerHost>
    				</configuration>
    			</plugin>
    		</plugins>
    	</build>
    	<!-- === docker build copy END === -->
    ```

    

 2. é…ç½® jenkens

    å…¶å®åˆ°è¿™é‡Œå¼€å‘äººå‘˜çš„å·¥ä½œå·²ç»å®Œæˆã€‚æ¥ä¸‹æ¥æ˜¯è¿ç»´çš„å·¥ä½œäº†ã€‚

    jenkins è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹æ“ä½œçš„æè¿°ã€‚ä»ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æµæ°´çº¿ä»»åŠ¡ä¸­å¤åˆ¶ä¸€ä¸ªä»½å³å¯ã€‚

    ç™»å½• http://192.168.199.12:50006/ çš„jenkins  è´¦å·ï¼šadmin  å¯†ç ï¼š123456

    

    å‡å¦‚ä½ é…ç½®çš„é¡¹ç›® pom.xml æ–‡ä»¶åœ¨ `pig-upms/pig-upms-biz` ä¸­ã€‚

    

    é‚£ä¹ˆ`pig-upms/pig-upms-biz`å°±æ˜¯ä½ éœ€è¦ Ctrl+C çš„å†…å®¹äº†ï¼Œèµ¶ç´§é€‰ä¸­æŒ‰ä¸‹å»ï¼ï¼ï¼ ğŸ‘

    

    å¤åˆ¶ pig-config ä»»åŠ¡æµæ°´çº¿å®Œæˆåï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

    - åœ¨ Optional Filter çš„ Expression ä¸­ã€‚ä¿®æ”¹å…¶ä¸­çš„è¿‡æ»¤è·¯å¾„ã€‚

      è¿™é‡Œéœ€è¦æŠŠ pig-config ä¿®æ”¹æˆ pig-upms/pig-upms-biz å³å¯ã€‚è¡¨ç¤ºåªè¦æ˜¯è¿™ä¸ªç›®å½•ä¸‹çš„æœ‰æ–°çš„æäº¤ï¼Œå°±ä¼šè§¦å‘è¯¥ä»»åŠ¡çš„æ‰“åŒ…åŠ¨ä½œã€‚ï¼ˆåªæ˜¯è§¦å‘åŠ¨ä½œï¼Œä¸æ˜¯çœŸçš„æ‰“åŒ…ï¼Œæ‰“åŒ…é˜¶æ®µè¿˜éœ€è¦å…¶ä»–æ£€æŸ¥ï¼ï¼‰

      

      ```
      ^(refs/heads/dev)_([\s\S]*pig-config[\s\S]*)$
      ```

      ä¿®æ”¹ä¸ºï¼š

      ```
      ^(refs/heads/dev)_([\s\S]*pig-upms/pig-upms-biz[\s\S]*)$
      ```

    

    - åœ¨ Pipeline script ä¸­ï¼Œä¿®æ”¹ç›¸åº”çš„ä½ç½®ã€‚

      ```
      @Library('global-shared-library@master') _
      
      node {
          tfx0onePipeline([projectDir: 'pig-config'])
      }
      ```

      ä¿®æ”¹ä¸ºï¼š

      ```
      @Library('global-shared-library@master') _
      
      node {
          tfx0onePipeline([projectDir: ' pig-upms/pig-upms-biz'])
      }
      ```



3. å¦‚ä½•è§¦å‘æ‰“åŒ…ã€‚

çœ‹åˆ°è¿™é‡Œã€‚è¯´æ˜ä½ å·²ç»é…ç½®å®Œæˆäº†ã€‚é‚£ä¹ˆæ€ä¹ˆè§¦å‘æ‰“åŒ…å‘¢ï¼Ÿ

å¾ˆç®€å•ã€‚

å¼€å‘äººå‘˜å®Œæˆè‡ªå·±åŠŸèƒ½åï¼Œæ­£å¸¸åˆå¹¶åˆ°devåˆ†æ”¯ã€‚

å¦‚æœéœ€è¦æ‰“åŒ…é•œåƒï¼Œåšä¸€ä¸ªé¢å¤–çš„å·¥ä½œï¼šä¿®æ”¹pomæ–‡ä»¶ä¸­å¯¹åº”çš„ JunFengDockerImageVersion ç‰ˆæœ¬ã€‚

push è¯•è¯•ã€‚

å…·ä½“æ‰“åŒ…æ­¥éª¤ï¼š

    1. åœ¨éœ€è¦æ‰“åŒ…çš„pom, è¯·æŠŠJunFengDockerImageVersion é‡Œé¢çš„å€¼åŠ 1å³å¯ã€‚æ¯”å¦‚ 0.0.1 æ”¹æˆ0.0.2ã€‚
    2. æäº¤åˆ°devã€‚1åˆ†é’Ÿåè‡ªåŠ¨æ‰“åŒ…ã€‚
    3. å»jenkins çœ‹æ˜¯å¦æ‰“åŒ…æˆåŠŸã€‚ http://192.168.199.12:50006/


4. Q&A

   > Qï¼šå¦‚ä½•æŸ¥çœ‹é•œåƒæ˜¯å¦æˆåŠŸï¼Ÿ
   > Aï¼šæŸ¥çœ‹æˆåŠŸçš„æ‰“åŒ…æ—¥å¿—ã€‚ä¼šçœ‹åˆ° Building image 192.168.199.12:50000/pig-config:0.0.18ã€‚è¿™ä¸ªå°±æ˜¯å•¦ã€‚
